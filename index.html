<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Braille ATM</title>
  <link rel="manifest" href="manifest.json" />
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js');
    }
  </script>
  <style>
    body { font-family: sans-serif; background: #111; color: white; text-align: center; padding: 20px; position: relative; }
    input, button { padding: 10px; margin: 10px; font-size: 1.2em; }
    video { width: 100px; border: 2px solid white; position: absolute; top: 10px; right: 10px; }
    .hidden { display: none; }
    #dangerAlert {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: red;
      color: white;
      font-size: 2em;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <audio id="beepSound" src="https://www.soundjay.com/buttons/sounds/beep-07.mp3"></audio>
  <div id="dangerAlert">⚠️ DANGER: Suspicious Activity Detected</div>
  <video id="camera" autoplay muted playsinline></video>
  <h1>Welcome to Braille Bank</h1>
  <p id="instructions">Enter your Master PIN to access</p>
  <input type="password" id="pin" placeholder="Enter PIN" maxlength="4" /><br>
  <button id="verifyPin">Verify PIN</button>
  <div id="atmOptions" class="hidden">
    <button onclick="withdrawUI()">Withdraw</button>
    <button onclick="changePinUI()">Change PIN</button>
    <button onclick="showHistory()">View Transactions</button>
    <button onclick="resetDay()">Reset Day</button>
  </div>
  <div id="withdrawDiv" class="hidden">
    <input type="number" id="amount" placeholder="Amount to withdraw" /><br>
    <button onclick="withdraw()">Confirm Withdraw</button>
    <button onclick="goBack()">Back</button>
  </div>
  <div id="changePinDiv" class="hidden">
    <input type="password" id="newPin" placeholder="New PIN" maxlength="4" /><br>
    <button onclick="changePin()">Change</button>
    <button onclick="goBack()">Back</button>
  </div>
  <pre id="log"></pre>
  <script>
    let correctPin = localStorage.getItem('atm_pin') || '9770';
    let balance = parseInt(localStorage.getItem('atm_balance') || '100000000000');
    let dailyLimit = 50000;
    let usedToday = parseInt(localStorage.getItem('used_today') || '0');
    let failCount = 0;
    let lastReset = localStorage.getItem('last_reset');
    let camBlockedFrames = 0;
    let dangerTriggered = false;

    if (!lastReset || (Date.now() - lastReset) > 86400000) {
      usedToday = 0;
      localStorage.setItem('used_today', '0');
      localStorage.setItem('last_reset', Date.now());
    }

    function speak(text) {
      const synth = window.speechSynthesis;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'en-IN';
      utter.pitch = 1.2;
      utter.rate = 1;
      utter.voice = synth.getVoices().find(voice => voice.name.includes('Google UK English Male')) || null;
      synth.speak(utter);
    }

    function showDangerScreen() {
      if (dangerTriggered) return;
      dangerTriggered = true;
      const alert = document.getElementById('dangerAlert');
      const beep = document.getElementById('beepSound');
      alert.style.display = 'flex';
      beep.loop = true;
      beep.play().catch(() => {
        console.warn('Autoplay blocked. Will try again after user gesture.');
      });
      speak("Danger! Suspicious activity detected. Security alerted.");
    }

    document.getElementById('pin').addEventListener('input', e => {
      const digit = e.data;
      if (digit) speak(digit);
    });

    document.getElementById('verifyPin').addEventListener('click', () => {
      const entered = document.getElementById('pin').value;
      if (entered === correctPin) {
        document.getElementById('atmOptions').classList.remove('hidden');
        document.getElementById('verifyPin').classList.add('hidden');
        document.getElementById('pin').classList.add('hidden');
        speak("PIN correct. Choose an option.");
      } else {
        failCount++;
        speak("Incorrect PIN");
        if (failCount >= 3) {
          showDangerScreen();
        }
      }
    });

    function withdrawUI() {
      document.getElementById('withdrawDiv').classList.remove('hidden');
      document.getElementById('atmOptions').classList.add('hidden');
      speak("Enter amount to withdraw");
    }

    function changePinUI() {
      document.getElementById('changePinDiv').classList.remove('hidden');
      document.getElementById('atmOptions').classList.add('hidden');
      speak("Enter new 4 digit PIN");
    }

    function withdraw() {
      const amt = parseInt(document.getElementById('amount').value);
      if (isNaN(amt)) return speak("Please enter a valid amount");
      speak(amt.toString().split('').join(', '));
      if (amt > 50000 || usedToday + amt > 50000) {
        speak("Daily withdrawal limit exceeded");
        return;
      }
      if (amt > balance) {
        speak("Insufficient funds");
        return;
      }
      balance -= amt;
      usedToday += amt;
      localStorage.setItem('atm_balance', balance);
      localStorage.setItem('used_today', usedToday);
      let tx = JSON.parse(localStorage.getItem('transactions') || '[]');
      tx.push({ amt, time: new Date().toLocaleString() });
      localStorage.setItem('transactions', JSON.stringify(tx));
      speak(`Transaction successful. Your new balance is ${balance}`);
      alert(`Transaction successful. Balance: ₹${balance}`);
      goBack();
    }

    function changePin() {
      const npin = document.getElementById('newPin').value;
      if (npin.length !== 4) return speak("PIN must be 4 digits");
      correctPin = npin;
      localStorage.setItem('atm_pin', npin);
      speak("PIN changed successfully");
      goBack();
    }

    function goBack() {
      document.getElementById('atmOptions').classList.remove('hidden');
      document.getElementById('withdrawDiv').classList.add('hidden');
      document.getElementById('changePinDiv').classList.add('hidden');
    }

    function resetDay() {
      usedToday = 0;
      localStorage.setItem('used_today', '0');
      localStorage.setItem('last_reset', Date.now());
      speak("Daily limit reset");
    }

    function showHistory() {
      const tx = JSON.parse(localStorage.getItem('transactions') || '[]');
      document.getElementById('log').innerText = tx.slice(-5).map(t => `${t.time}: ₹${t.amt}`).join('\n');
      speak("Last 5 transactions displayed");
    }

    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      const video = document.getElementById('camera');
      video.srcObject = stream;
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      setInterval(() => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const pixels = frame.data;
        let dark = 0;
        for (let i = 0; i < pixels.length; i += 4) {
          const brightness = (pixels[i] + pixels[i + 1] + pixels[i + 2]) / 3;
          if (brightness < 30) dark++;
        }
        const total = pixels.length / 4;
        if ((dark / total) > 0.9) {
          showDangerScreen();
        }
      }, 1000);
    }).catch(() => {
      speak("Camera access denied. Unable to detect suspicious activity.");
    });

    speak("Welcome to Braille Bank. Please enter your PIN.");
  </script>
</body>
</html>
