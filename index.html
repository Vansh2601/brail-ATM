<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Braille ATM</title>
  <link rel="manifest" href="manifest.json" />
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js');
    }
  </script>

  <style>
    body {font-family: sans-serif; background:#111; color:#0f0; text-align:center; position:relative; padding:20px;}
    input, button {padding:10px;margin:8px;font-size:1rem;}
    .hidden {display:none;}
    #dangerAlert{
      background:red;color:white;position:fixed;top:0;left:0;width:100%;height:100%;
      display:none;align-items:center;justify-content:center;z-index:9999;font-size:2rem;
    }
  </style>
</head>
<body>
  <audio id="beep" preload="auto">
    <source src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" type="audio/mpeg">
  </audio>

  <div id="dangerAlert">‚ö†Ô∏è ‡§ñ‡§§‡§∞‡§æ: ‡§∏‡§Ç‡§¶‡§ø‡§ó‡•ç‡§ß ‡§ó‡§§‡§ø‡§µ‡§ø‡§ß‡§ø ‡§™‡§æ‡§à ‡§ó‡§à</div>
  <video id="camera" autoplay muted playsinline></video>

  <h1>‡§¨‡•ç‡§∞‡•á‡§≤ ‡§¨‡•à‡§Ç‡§ï ‡§è‡§ü‡•Ä‡§è‡§Æ</h1>

  <!-- CARD LOGIN -->
  <div id="cardLogin">
    <input type="text" id="cardNo" placeholder="‡§ï‡§æ‡§∞‡•ç‡§° ‡§®‡§Ç‡§¨‡§∞"/>
    <button onclick="enterCard()">‡§Ü‡§ó‡•á ‡§¨‡§¢‡§º‡•á‡§Ç</button>
  </div>

  <!-- PIN LOGIN -->
  <div id="pinLogin" class="hidden">
    <input type="password" id="pin" placeholder="‡§™‡§ø‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç" maxlength="4"/>
    <button onclick="verifyPIN()">‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç</button>
  </div>

  <!-- ATM MENU -->
  <div id="menu" class="hidden">
    <button onclick="withdrawUI()">‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä</button>
    <button onclick="changePinUI()">‡§™‡§ø‡§® ‡§¨‡§¶‡§≤‡•á‡§Ç</button>
    <button onclick="showHistory()">‡§≤‡•á‡§®‡§¶‡•á‡§®</button>
    <button onclick="toggleContrast()">‡§ï‡•â‡§®‡•ç‡§ü‡•ç‡§∞‡§æ‡§∏‡•ç‡§ü ‡§¨‡§¶‡§≤‡•á‡§Ç</button>
    <button onclick="startAdmin()">‡§è‡§°‡§Æ‡§ø‡§®</button>
  </div>

  <!-- WITHDRAW -->
  <div id="withdrawDiv" class="hidden">
    <input type="number" id="amount" placeholder="‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä ‡§∞‡§æ‡§∂‡§ø"/>
    <button onclick="withdraw()">‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç</button>
    <button onclick="goBack()">‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Ç</button>
  </div>

  <!-- CHANGE PIN -->
  <div id="changeDiv" class="hidden">
    <input type="password" id="newPin" placeholder="‡§®‡§Ø‡§æ ‡§™‡§ø‡§®" maxlength="4"/>
    <button onclick="changePin()">‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç</button>
    <button onclick="goBack()">‡§µ‡§æ‡§™‡§∏ ‡§ú‡§æ‡§è‡§Ç</button>
  </div>



  <script>
/************ ‡§°‡•á‡§ü‡§æ ‡§î‡§∞ ‡§â‡§™‡§Ø‡•ã‡§ó‡•Ä ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® ****************/
const users = JSON.parse(localStorage.getItem('BrailleATM_users')) || {
  "0001": { pin: "9770", balance: 100000, tx: [] },
  "0002": { pin: "2222", balance: 50000,  tx: [] },
  "1234": { pin: "0987", balance: 20000,  tx: [] }
};
let activeCard = "";
const maxDaily = 15000;
let dailyUsed = parseInt(localStorage.getItem('dailyUsed')||'0');
let lastReset = localStorage.getItem('lastReset');
let idleTimer;
let dangerTriggered = false;

// ‡§π‡§∞ 24 ‡§ò‡§Ç‡§ü‡•á ‡§Æ‡•á‡§Ç ‡§≤‡§ø‡§Æ‡§ø‡§ü ‡§∞‡•Ä‡§∏‡•á‡§ü
if(!lastReset || (Date.now() - lastReset) > 86400000){
  dailyUsed = 0;
  localStorage.setItem("dailyUsed","0");
  localStorage.setItem("lastReset", Date.now());
}

function saveUsers(){ localStorage.setItem('BrailleATM_users', JSON.stringify(users)); }

function speak(text){
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "hi-IN";
  u.pitch = 1;
  u.rate = 0.95;
  speechSynthesis.speak(u);
}

function resetIdle(){
  clearTimeout(idleTimer);
  idleTimer = setTimeout(()=>{ showPINScreen() },30000);
}

/************ ‡§≤‡•â‡§ó‡§ø‡§® ****************/
function enterCard(){
  const card = document.getElementById('cardNo').value.trim();
  if(!users[card]){ alert("‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ï‡§æ‡§∞‡•ç‡§° ‡§®‡§Ç‡§¨‡§∞"); return; }
  activeCard = card;
  document.getElementById('cardLogin').classList.add('hidden');
  document.getElementById('pinLogin').classList.remove('hidden');
  speak("‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§ø‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç");
  resetIdle();
}

function verifyPIN(){
  const p = document.getElementById('pin').value;
  if(p === users[activeCard].pin){
    document.getElementById('pinLogin').classList.add('hidden');
    document.getElementById('menu').classList.remove('hidden');
    speak("‡§™‡§ø‡§® ‡§∏‡§π‡•Ä ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§");
  }else{
    speak("‡§ó‡§≤‡§§ ‡§™‡§ø‡§®‡•§");
    showDanger();
  }
  resetIdle();
}

/************ ‡§Æ‡•á‡§®‡•Ç ‡§è‡§ï‡•ç‡§∂‡§® ****************/
function withdrawUI(){
  document.getElementById('menu').classList.add('hidden');
  document.getElementById('withdrawDiv').classList.remove('hidden');
  speak("‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä ‡§∞‡§æ‡§∂‡§ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§¨‡•ã‡§≤‡•á‡§Ç‡•§");
  function startSpeechRecognition(){
  if(!('webkitSpeechRecognition' in window)){
    alert("Speech recognition not supported in this browser");
    return;
  }
  const rec = new webkitSpeechRecognition();
  rec.lang = 'hi-IN'; // üëà Hindi recognition
  rec.continuous = true; // Keep listening
  rec.interimResults = false;

  speak("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∞‡§æ‡§∂‡§ø ‡§¨‡•ã‡§≤‡§ø‡§è ‡§ú‡§ø‡§∏‡•á ‡§Ü‡§™ ‡§®‡§ø‡§ï‡§æ‡§≤‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç‡•§");

  rec.onresult = (e) => {
    const s = e.results[e.results.length - 1][0].transcript.toLowerCase();
    console.log("Heard:", s);
    const n = parseInt(s.replace(/\D/g, ''));
    if(!isNaN(n)){
      document.getElementById('amount').value = n;
      speak(`‡§Ü‡§™‡§®‡•á ${n} ‡§∞‡•Å‡§™‡§Ø‡•á ‡§ï‡§π‡•á ‡§π‡•à‡§Ç‡•§ ‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§®‡•ç‡§´‡§∞‡•ç‡§Æ ‡§¶‡§¨‡§æ‡§è‡§Ç‡•§`);
    } else {
      speak("‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∞‡§æ‡§∂‡§ø ‡§¨‡•ã‡§≤‡§ø‡§è‡•§");
    }
  };

  rec.onerror = (err) => {
    console.error("Speech error:", err);
    speak("‡§µ‡•â‡§á‡§∏ ‡§á‡§®‡§™‡•Å‡§ü ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§π‡•Å‡§à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¶‡•ã‡§¨‡§æ‡§∞‡§æ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§");
  };

  rec.start();
}
;
  resetIdle();
}

function withdraw(){
  const amt = parseInt(document.getElementById('amount').value);
  if(isNaN(amt)){ speak("‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∞‡§æ‡§∂‡§ø"); return;}
  if(amt > users[activeCard].balance){ speak("‡§™‡§∞‡•ç‡§Ø‡§æ‡§™‡•ç‡§§ ‡§∞‡§æ‡§∂‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à"); return;}
  if(dailyUsed + amt > maxDaily){ speak("‡§¶‡•à‡§®‡§ø‡§ï ‡§∏‡•Ä‡§Æ‡§æ ‡§™‡•Ç‡§∞‡•Ä ‡§π‡•ã ‡§ö‡•Å‡§ï‡•Ä ‡§π‡•à"); return;}
  users[activeCard].balance -= amt;
  users[activeCard].tx.push({time: new Date().toLocaleString(), amt});
  dailyUsed += amt;
  saveUsers();
  localStorage.setItem("dailyUsed", dailyUsed);

  // PDF ‡§∞‡§∏‡•Ä‡§¶ ‡§¨‡§®‡§æ‡§è‡§Ç ‡§î‡§∞ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
  generatePDF(amt);
  speak(`‡§≤‡•á‡§®‡§¶‡•á‡§® ‡§∏‡§´‡§≤ ‡§∞‡§π‡§æ‡•§ ‡§Ü‡§™‡§ï‡•Ä ‡§®‡§à ‡§∂‡•á‡§∑ ‡§∞‡§æ‡§∂‡§ø ‡§π‡•à ‚Çπ${users[activeCard].balance}`);
  goBack();
  resetIdle();
}

function changePinUI(){
  document.getElementById('menu').classList.add('hidden');
  document.getElementById('changeDiv').classList.remove('hidden');
  speak("‡§®‡§Ø‡§æ ‡§™‡§ø‡§® ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç");
  resetIdle();
}

function changePin(){
  const np = document.getElementById('newPin').value;
  if(!/^[0-9]{4}$/.test(np)){ speak("‡§™‡§ø‡§® 4 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§π‡•ã‡§®‡§æ ‡§ö‡§æ‡§π‡§ø‡§è"); return;}
  users[activeCard].pin = np;
  saveUsers();
  speak("‡§™‡§ø‡§® ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§¨‡§¶‡§≤ ‡§¶‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à");
  goBack();
  resetIdle();
}

function showHistory(){
  const list = users[activeCard].tx.slice(-5).map(e=>`${e.time} : ‚Çπ${e.amt}`).join("\n");
  document.getElementById('output').innerText = list || "‡§ï‡•ã‡§à ‡§π‡§æ‡§≤‡§ø‡§Ø‡§æ ‡§≤‡•á‡§®‡§¶‡•á‡§® ‡§®‡§π‡•Ä‡§Ç";
  speak("‡§Ü‡§™‡§ï‡•á ‡§π‡§æ‡§≤‡§ø‡§Ø‡§æ ‡§≤‡•á‡§®‡§¶‡•á‡§® ‡§¶‡§ø‡§ñ‡§æ‡§è ‡§ó‡§è ‡§π‡•à‡§Ç");
  resetIdle();
}

function goBack(){
  document.getElementById('withdrawDiv').classList.add('hidden');
  document.getElementById('changeDiv').classList.add('hidden');
  document.getElementById('menu').classList.remove('hidden');
  document.getElementById('output').innerText = '';
  resetIdle();
}

/************ ‡§∏‡•ç‡§™‡•Ä‡§ö ‡§∞‡§ø‡§ï‡§ó‡•ç‡§®‡§ø‡§∂‡§® ****************/
function startSpeechRecognition(){
  if(!('webkitSpeechRecognition' in window)) return;
  const rec = new webkitSpeechRecognition();
  rec.lang='hi-IN';
  rec.onresult=(e)=>{
      const s = e.results[0][0].transcript.toLowerCase();
      const n = parseInt(s.replace(/\D/g,''));
      if(!isNaN(n)) document.getElementById('amount').value = n;
  };
  rec.start();
}

/************ PDF ‡§∞‡§∏‡•Ä‡§¶ ****************/
function generatePDF(amt){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const text = `‡§¨‡•ç‡§∞‡•á‡§≤ ‡§¨‡•à‡§Ç‡§ï ‡§è‡§ü‡•Ä‡§è‡§Æ ‡§∞‡§∏‡•Ä‡§¶\n‡§ï‡§æ‡§∞‡•ç‡§°: ${activeCard}\n‡§®‡§ø‡§ï‡§æ‡§∏‡•Ä: ‚Çπ${amt}\n‡§∂‡•á‡§∑ ‡§∞‡§æ‡§∂‡§ø: ‚Çπ${users[activeCard].balance}\n‡§∏‡§Æ‡§Ø: ${new Date().toLocaleString()}`;
  doc.text(text, 10, 10);
  doc.save(`ATM_Receipt_${Date.now()}.pdf`);
}

/************ ‡§°‡•á‡§Ç‡§ú‡§∞ + ‡§ï‡•à‡§Æ‡§∞‡§æ ****************/
function showDanger() {
  if (dangerTriggered) return;
  dangerTriggered = true;
  document.getElementById('dangerAlert').style.display = 'flex';
  const beep = document.getElementById('beep');
  beep.loop = true;
  beep.play().catch(()=>{});
  speak('‡§ñ‡§§‡§∞‡§æ‡•§ ‡§∏‡§Ç‡§¶‡§ø‡§ó‡•ç‡§ß ‡§ó‡§§‡§ø‡§µ‡§ø‡§ß‡§ø ‡§™‡§æ‡§à ‡§ó‡§à ‡§π‡•à‡•§');
  captureImage();
}

function captureImage(){
  const video = document.getElementById('camera');
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video,0,0);
  const imgData = canvas.toDataURL('image/png');
  let shots = JSON.parse(localStorage.getItem('capturedShots')||'[]');
  shots.push({card:activeCard, time:new Date().toLocaleString(), data:imgData});
  localStorage.setItem('capturedShots',JSON.stringify(shots));
}

/************ ‡§ï‡•à‡§Æ‡§∞‡§æ ‡§Æ‡•â‡§®‡§ø‡§ü‡§∞‡§ø‡§Ç‡§ó ****************/
navigator.mediaDevices.getUserMedia({video:true}).then(stream=>{
   const video=document.getElementById('camera');
   video.srcObject = stream;
   const faceDetector =  ('FaceDetector' in window) ? new FaceDetector() : null;
   const canvas = document.createElement('canvas');
   const ctx = canvas.getContext('2d');
   setInterval(async ()=>{
     resetIdle();
     if(!video.videoWidth) return;
     canvas.width = video.videoWidth;
     canvas.height = video.videoHeight;
     ctx.drawImage(video,0,0);
     const frame = ctx.getImageData(0,0,canvas.width,canvas.height).data;
     let dark=0;
     for(let i=0;i<frame.length;i+=4){
       const b=(frame[i]+frame[i+1]+frame[i+2])/3;
       if(b<30) dark++;
     }
     if((dark/(frame.length/4))>0.9){ showDanger(); return;}
     if(faceDetector){
       try{
         const faces = await faceDetector.detect(video);
         if(faces.length>1) showDanger();
       }catch(e){}
     }
   },500);
}).catch(()=>{
   speak('‡§ï‡•à‡§Æ‡§∞‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§‡•§ ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ ‡§®‡§ø‡§∑‡•ç‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§π‡•à‡•§');
});

/************ ‡§∞‡•Ä‡§∏‡•á‡§ü ****************/
function showPINScreen(){
  document.getElementById('menu').classList.add('hidden');
  document.getElementById('withdrawDiv').classList.add('hidden');
  document.getElementById('changeDiv').classList.add('hidden');
  document.getElementById('adminPanel').style.display='none';
  document.getElementById('pinLogin').classList.add('hidden');
  document.getElementById('cardLogin').classList.remove('hidden');
  document.getElementById('output').innerText='';
  dangerTriggered=false;
  speechSynthesis.cancel();
}

speak('‡§¨‡•ç‡§∞‡•á‡§≤ ‡§¨‡•à‡§Ç‡§ï ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§æ‡§∞‡•ç‡§° ‡§®‡§Ç‡§¨‡§∞ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§');
resetIdle();

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>


