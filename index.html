<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Braille ATM</title>

  <style>
    body {font-family:sans-serif; background:#111; color:#0f0; text-align:center; padding:20px;}
    input, button {padding:10px;margin:8px;font-size:1rem;}
    .hidden {display:none;}
    #dangerAlert{
      background:red;color:white;position:fixed;top:0;left:0;width:100%;height:100%;
      display:none;align-items:center;justify-content:center;z-index:9999;font-size:2rem;
    }
    video{position:absolute;top:10px;right:10px;width:100px;border:2px solid #fff;}
  </style>
</head>
<body>
  <audio id="beep" preload="auto">
    <source src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" type="audio/mpeg">
  </audio>

  <div id="dangerAlert">⚠️ खतरा: संदिग्ध गतिविधि पाई गई</div>
  <video id="camera" autoplay muted playsinline></video>

  <h1>ब्रेल बैंक एटीएम</h1>

  <!-- CARD LOGIN -->
  <div id="cardLogin">
    <input type="text" id="cardNo" placeholder="कार्ड नंबर दर्ज करें"/>
    <button onclick="enterCard()">जारी रखें</button>
    <br/>
    <button onclick="showRegister()">नया कार्ड पंजीकृत करें</button>
  </div>

  <!-- REGISTER NEW CARD -->
  <div id="registerDiv" class="hidden">
    <h3>नया कार्ड पंजीकरण</h3>
    <input type="text" id="newCard" placeholder="नया कार्ड नंबर"/>
    <input type="password" id="newPinReg" placeholder="नया पिन (4 अंक)" maxlength="4"/>
    <input type="number" id="initialAmt" placeholder="प्रारंभिक जमा राशि"/>
    <button onclick="registerCard()">पंजीकरण करें</button>
    <button onclick="cancelRegister()">वापस</button>
  </div>

  <!-- PIN LOGIN -->
  <div id="pinLogin" class="hidden">
    <input type="password" id="pin" placeholder="पिन दर्ज करें" maxlength="4"/>
    <button onclick="verifyPIN()">पिन सत्यापित करें</button>
  </div>

  <!-- ATM MENU -->
  <div id="menu" class="hidden">
    <button onclick="withdrawUI()">निकासी</button>
    <button onclick="changePinUI()">पिन बदलें</button>
    <button onclick="showHistory()">लेन-देन इतिहास</button>
  </div>

  <!-- WITHDRAW -->
  <div id="withdrawDiv" class="hidden">
    <input type="number" id="amount" placeholder="निकासी राशि दर्ज करें"/>
    <button onclick="withdraw()">पुष्टि करें</button>
    <button onclick="goBack()">वापस</button>
  </div>

  <!-- CHANGE PIN -->
  <div id="changeDiv" class="hidden">
    <input type="password" id="newPin" placeholder="नया पिन दर्ज करें" maxlength="4"/>
    <button onclick="changePin()">पुष्टि करें</button>
    <button onclick="goBack()">वापस</button>
  </div>

  <pre id="output"></pre>

  <script>
/************ डेटा + उपयोगी फंक्शन ****************/
const users = JSON.parse(localStorage.getItem('BrailleATM_users')) || {
  "0001": { pin: "9770", balance: 100000, tx: [] },
  "0002": { pin: "2222", balance: 50000, tx: [] }
};
let activeCard = "";
const maxDaily = 50000;
let dailyUsed = parseInt(localStorage.getItem('dailyUsed')||'0');
let lastReset = localStorage.getItem('lastReset');
let idleTimer;
let dangerTriggered = false;

if(!lastReset || (Date.now() - lastReset) > 86400000){
  dailyUsed = 0;
  localStorage.setItem("dailyUsed","0");
  localStorage.setItem("lastReset", Date.now());
}

function saveUsers(){ localStorage.setItem('BrailleATM_users', JSON.stringify(users)); }

function speak(text){
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "hi-IN";
  u.pitch = 1.0;
  u.rate = 0.9;
  speechSynthesis.speak(u);
}

function resetIdle(){
  clearTimeout(idleTimer);
  idleTimer = setTimeout(()=>{ showPINScreen() },40000);
}

/************ कार्ड लॉगिन ****************/
function enterCard(){
  const card = document.getElementById('cardNo').value.trim();
  if(!users[card]){ speak("अज्ञात कार्ड। कृपया सही कार्ड नंबर दर्ज करें या नया कार्ड बनाएं।"); return; }
  activeCard = card;
  document.getElementById('cardLogin').classList.add('hidden');
  document.getElementById('pinLogin').classList.remove('hidden');
  speak("कृपया कार्ड " + card + " के लिए पिन दर्ज करें।");
  resetIdle();
}

/************ नया कार्ड पंजीकरण ****************/
function showRegister(){
  document.getElementById('cardLogin').classList.add('hidden');
  document.getElementById('registerDiv').classList.remove('hidden');
  speak("नया कार्ड पंजीकृत करें। कार्ड नंबर, चार अंकों का पिन और जमा राशि दर्ज करें।");
}

function registerCard(){
  const newCard = document.getElementById('newCard').value.trim();
  const newPin = document.getElementById('newPinReg').value.trim();
  const initAmt = parseInt(document.getElementById('initialAmt').value);

  if(!newCard || users[new]()
